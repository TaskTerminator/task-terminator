'use strict';

var mongoose = require('mongoose');
var Project = require('../models/Project.js');
var ProjectTask = require('../models/ProjectTask.js');
var Template = require('../models/Template');
var TemplateTask = require('../models/TemplateTask.js');
var timeCtrl = require('../controllers/timeCtrl');
var helpers = require('../controllers/projectHelpers');
var _ = require('underscore');
var Q = require('q');
var randomstring = require('randomstring');
var Employee = require('../models/Employee.js');

module.exports = {
  endpointProject: function endpointProject(req, res) {
    var templateId = req.params.templateid;
    var instance = req.body.instance;
    var description = req.body.description;
    module.exports.newProject(templateId, description, instance).then(function (project) {
      return res.json(project);
    });
  },
  newProject: function newProject(templateId, description, instance) {
    console.log("#1 - New Project Function Called");
    var deferred = Q.defer();
    var associatedProjectId;
    var newProject;
    helpers.makeProjectObject(templateId).then(function (cleanObject) {
      console.log("#3 - Make Project Object Returned: ", cleanObject);
      newProject = new Project(cleanObject);
      newProject.friendlyId = randomstring.generate({ length: 5, readable: true });
      console.log("#4 - New Project Id : ", newProject._id);
      associatedProjectId = newProject._id;
      console.log("#5 - associatedProjectId :", associatedProjectId);
      return helpers.nextOccurrence(cleanObject, instance);
    }).then(function (deadline) {
      console.log("#14 - Next Occurance Returned: ", deadline);
      newProject.setup.dueDate.actual = deadline;
      console.log("#15 - New Project Deadline Set : ", newProject.setup.dueDate.actual);
      return helpers.getTaskArray(templateId);
    }).then(function (arrayofIds) {
      console.log("#17 - Returned From Task Array Helper ", arrayofIds);
      //for every id, make a new project task
      var new_tasks_promises = _.map(arrayofIds, function (id) {
        console.log("Array of Ids ID ", id);
        return helpers.makeTemplateTaskObject(id, associatedProjectId);
      });
      //new_tasks_promises now contains an array of promises which will be resolved as each of the tasks are created
      console.log("#19 - Array of New Task Promises", new_tasks_promises);
      return Q.all(new_tasks_promises);
    }).then(function (clean_objects) {
      console.log("#20 - Array of New Task Objects", clean_objects);
      return Q.all(_.map(clean_objects, function (clean_object) {
        return helpers.makeProjectTask(clean_object, associatedProjectId);
      }));
    }).then(function (project_tasks) {
      console.log("#22 - Project Tasks", project_tasks);
      //take tasks, put in Project, save
      newProject.description = description;
      for (var i = 0; i < project_tasks.length; i++) {
        newProject.tasks.push(project_tasks[i]);
      }
      newProject.setup.associatedTemplate = templateId;
      newProject.save().then(function (project) {
        console.log("Made it!");
        deferred.resolve(project);
      });
    });
    return deferred.promise;
  },
  newSingleProject: function newSingleProject(req, res) {
    var newProject = new Project(req.body);
    newProject.friendlyId = randomstring.generate({ length: 5, readable: true });
    newProject.save().then(function (project) {
      return res.json(project);
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  newTriggeredProject: function newTriggeredProject(req, res) {
    console.log("#1 - New Project Function Called");
    var templateId = req.params.templateid;
    var instance = req.body.instance;
    var description = req.body.description;
    var associatedProjectId;
    var newProject;
    helpers.makeProjectObject(templateId).then(function (cleanObject) {
      console.log("#3 - Make Project Object Returned: ", cleanObject);
      newProject = new Project(cleanObject);
      newProject.friendlyId = randomstring.generate({ length: 5, readable: true });
      console.log("#4 - New Project Id : ", newProject._id);
      associatedProjectId = newProject._id;
      console.log("#5 - associatedProjectId :", associatedProjectId);
      return timeCtrl.triggeredProjectDeadline();
    }).then(function (deadline) {
      console.log("#14 - Next Occurance Returned: ", deadline);
      newProject.setup.dueDate.actual = deadline;
      console.log("#15 - New Project Deadline Set : ", newProject.setup.dueDate.actual);
      return helpers.getTaskArray(templateId);
    }).then(function (arrayofIds) {
      console.log("#17 - Returned From Task Array Helper ", arrayofIds);
      //for every id, make a new project task
      var new_tasks_promises = _.map(arrayofIds, function (id) {
        console.log("Array of Ids ID ", id);
        return helpers.makeTemplateTaskObject(id, associatedProjectId);
      });
      //new_tasks_promises now contains an array of promises which will be resolved as each of the tasks are created
      console.log("#19 - Array of New Task Promises", new_tasks_promises);
      return Q.all(new_tasks_promises);
    }).then(function (clean_objects) {
      console.log("#20 - Array of New Task Objects", clean_objects);
      return Q.all(_.map(clean_objects, function (clean_object) {
        return helpers.makeProjectTask(clean_object, associatedProjectId);
      }));
    }).then(function (project_tasks) {
      console.log("#22 - Project Tasks", project_tasks);
      //take tasks, put in Project, save
      newProject.description = description;
      for (var i = 0; i < project_tasks.length; i++) {
        newProject.tasks.push(project_tasks[i]);
      }
      newProject.save().then(function (project) {
        console.log("Made it!");
        return res.json(project);
      });
    });
  },
  oneProject: function oneProject(req, res) {
    var templateOptions = {
      path: 'tasks',
      model: 'ProjectTask',
      populate: {
        path: "assignment.employees",
        model: "Employee",
        select: "identification.name.fullName"
      }
    };
    Project.findById(req.params.id).populate(templateOptions).exec().then(function (result) {
      return res.json(result);
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  editProject: function editProject(req, res) {
    Project.update({ _id: req.params.id }, req.body).then(function () {
      return res.status(200).end();
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  deleteProject: function deleteProject(req, res) {
    Project.remove({ _id: req.params.id }, req.body).then(function () {
      return res.status(200).end();
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  allProjects: function allProjects(req, res) {
    Project.find().populate('tasks').exec().then(function (result) {
      return res.json(result);
    }).catch(function (err) {
      return res.status(500).end();
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlcl9hc3NldHMvY29udHJvbGxlcnMvcHJvamVjdEN0cmwuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDckMsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDaEQsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDeEQsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDL0MsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDMUQsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUM7QUFDcEQsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFDekQsSUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ2hDLElBQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2QixJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDN0MsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7O0FBR2xELE1BQU0sQ0FBQyxPQUFPLEdBQUc7QUFFYixpQkFBZSwyQkFBQyxHQUFHLEVBQUUsR0FBRyxFQUFFO0FBQ3RCLFFBQUksVUFBVSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO0FBQ3ZDLFFBQUksUUFBUSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQ2pDLFFBQUksV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLFVBQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQzNE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Y2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XG5jb25zdCBQcm9qZWN0ID0gcmVxdWlyZSgnLi4vbW9kZWxzL1Byb2plY3QuanMnKTtcbmNvbnN0IFByb2plY3RUYXNrID0gcmVxdWlyZSgnLi4vbW9kZWxzL1Byb2plY3RUYXNrLmpzJyk7XG5jb25zdCBUZW1wbGF0ZSA9IHJlcXVpcmUoJy4uL21vZGVscy9UZW1wbGF0ZScpO1xuY29uc3QgVGVtcGxhdGVUYXNrID0gcmVxdWlyZSgnLi4vbW9kZWxzL1RlbXBsYXRlVGFzay5qcycpO1xuY29uc3QgdGltZUN0cmwgPSByZXF1aXJlKCcuLi9jb250cm9sbGVycy90aW1lQ3RybCcpO1xuY29uc3QgaGVscGVycyA9IHJlcXVpcmUoJy4uL2NvbnRyb2xsZXJzL3Byb2plY3RIZWxwZXJzJyk7XG5jb25zdCBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpO1xuY29uc3QgUSA9IHJlcXVpcmUoJ3EnKTtcbmNvbnN0IHJhbmRvbXN0cmluZyA9IHJlcXVpcmUoJ3JhbmRvbXN0cmluZycpO1xuY29uc3QgRW1wbG95ZWUgPSByZXF1aXJlKCcuLi9tb2RlbHMvRW1wbG95ZWUuanMnKTtcblxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIGVuZHBvaW50UHJvamVjdChyZXEsIHJlcykge1xuICAgICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlcS5wYXJhbXMudGVtcGxhdGVpZDtcbiAgICAgICAgdmFyIGluc3RhbmNlID0gcmVxLmJvZHkuaW5zdGFuY2U7XG4gICAgICAgIHZhciBkZXNjcmlwdGlvbiA9IHJlcS5ib2R5LmRlc2NyaXB0aW9uO1xuICAgICAgICBtb2R1bGUuZXhwb3J0cy5uZXdQcm9qZWN0KHRlbXBsYXRlSWQsIGRlc2NyaXB0aW9uLCBpbnN0YW5jZSlcbiAgICAgICAgLnRoZW4oKHByb2plY3QpID0+IHtcbiAgICAgICAgICAgIHJldHVybiByZXMuanNvbihwcm9qZWN0KTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICBuZXdQcm9qZWN0KHRlbXBsYXRlSWQsIGRlc2NyaXB0aW9uLGluc3RhbmNlKSB7XG4gICAgY29uc29sZS5sb2coXCIjMSAtIE5ldyBQcm9qZWN0IEZ1bmN0aW9uIENhbGxlZFwiKTtcbiAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XG4gICAgdmFyIGFzc29jaWF0ZWRQcm9qZWN0SWQ7XG4gICAgdmFyIG5ld1Byb2plY3Q7XG4gICAgaGVscGVycy5tYWtlUHJvamVjdE9iamVjdCh0ZW1wbGF0ZUlkKVxuICAgICAgLnRoZW4oKGNsZWFuT2JqZWN0KSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzMgLSBNYWtlIFByb2plY3QgT2JqZWN0IFJldHVybmVkOiBcIiwgY2xlYW5PYmplY3QpO1xuICAgICAgICBuZXdQcm9qZWN0ID0gbmV3IFByb2plY3QoY2xlYW5PYmplY3QpO1xuICAgICAgICBuZXdQcm9qZWN0LmZyaWVuZGx5SWQgPSByYW5kb21zdHJpbmcuZ2VuZXJhdGUoe2xlbmd0aDogNSwgcmVhZGFibGU6IHRydWV9KTtcbiAgICAgICAgY29uc29sZS5sb2coXCIjNCAtIE5ldyBQcm9qZWN0IElkIDogXCIsIG5ld1Byb2plY3QuX2lkKTtcbiAgICAgICAgYXNzb2NpYXRlZFByb2plY3RJZCA9IG5ld1Byb2plY3QuX2lkO1xuICAgICAgICBjb25zb2xlLmxvZyhcIiM1IC0gYXNzb2NpYXRlZFByb2plY3RJZCA6XCIsIGFzc29jaWF0ZWRQcm9qZWN0SWQpO1xuICAgICAgICByZXR1cm4gaGVscGVycy5uZXh0T2NjdXJyZW5jZShjbGVhbk9iamVjdCwgaW5zdGFuY2UpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKChkZWFkbGluZSkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcIiMxNCAtIE5leHQgT2NjdXJhbmNlIFJldHVybmVkOiBcIiwgZGVhZGxpbmUpO1xuICAgICAgICBuZXdQcm9qZWN0LnNldHVwLmR1ZURhdGUuYWN0dWFsID0gZGVhZGxpbmU7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzE1IC0gTmV3IFByb2plY3QgRGVhZGxpbmUgU2V0IDogXCIsIG5ld1Byb2plY3Quc2V0dXAuZHVlRGF0ZS5hY3R1YWwpO1xuICAgICAgICByZXR1cm4gaGVscGVycy5nZXRUYXNrQXJyYXkodGVtcGxhdGVJZCk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKGFycmF5b2ZJZHMpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCIjMTcgLSBSZXR1cm5lZCBGcm9tIFRhc2sgQXJyYXkgSGVscGVyIFwiLCBhcnJheW9mSWRzKTtcbiAgICAgICAgLy9mb3IgZXZlcnkgaWQsIG1ha2UgYSBuZXcgcHJvamVjdCB0YXNrXG4gICAgICAgIHZhciBuZXdfdGFza3NfcHJvbWlzZXMgPSBfLm1hcChhcnJheW9mSWRzLCBmdW5jdGlvbihpZCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiQXJyYXkgb2YgSWRzIElEIFwiLCBpZCk7XG4gICAgICAgICAgcmV0dXJuIGhlbHBlcnMubWFrZVRlbXBsYXRlVGFza09iamVjdChpZCwgYXNzb2NpYXRlZFByb2plY3RJZCk7XG4gICAgICAgIH0pO1xuICAgICAgICAvL25ld190YXNrc19wcm9taXNlcyBub3cgY29udGFpbnMgYW4gYXJyYXkgb2YgcHJvbWlzZXMgd2hpY2ggd2lsbCBiZSByZXNvbHZlZCBhcyBlYWNoIG9mIHRoZSB0YXNrcyBhcmUgY3JlYXRlZFxuICAgICAgICBjb25zb2xlLmxvZyhcIiMxOSAtIEFycmF5IG9mIE5ldyBUYXNrIFByb21pc2VzXCIsIG5ld190YXNrc19wcm9taXNlcyk7XG4gICAgICAgIHJldHVybiBRLmFsbChuZXdfdGFza3NfcHJvbWlzZXMpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKChjbGVhbl9vYmplY3RzKSA9PntcbiAgICAgICAgY29uc29sZS5sb2coXCIjMjAgLSBBcnJheSBvZiBOZXcgVGFzayBPYmplY3RzXCIsIGNsZWFuX29iamVjdHMpO1xuICAgICAgICByZXR1cm4gUS5hbGwoXy5tYXAoY2xlYW5fb2JqZWN0cywgKGNsZWFuX29iamVjdCkgPT4ge1xuICAgICAgICAgIHJldHVybiBoZWxwZXJzLm1ha2VQcm9qZWN0VGFzayhjbGVhbl9vYmplY3QsIGFzc29jaWF0ZWRQcm9qZWN0SWQpO1xuICAgICAgICB9KSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKHByb2plY3RfdGFza3MpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCIjMjIgLSBQcm9qZWN0IFRhc2tzXCIsIHByb2plY3RfdGFza3MpO1xuICAgICAgICAvL3Rha2UgdGFza3MsIHB1dCBpbiBQcm9qZWN0LCBzYXZlXG4gICAgICAgIG5ld1Byb2plY3QuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9qZWN0X3Rhc2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgbmV3UHJvamVjdC50YXNrcy5wdXNoKHByb2plY3RfdGFza3NbaV0pO1xuICAgICAgICB9XG4gICAgICAgIG5ld1Byb2plY3Quc2V0dXAuYXNzb2NpYXRlZFRlbXBsYXRlID0gdGVtcGxhdGVJZDtcbiAgICAgICAgbmV3UHJvamVjdC5zYXZlKCkudGhlbigocHJvamVjdCkgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWFkZSBpdCFcIik7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHByb2plY3QpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfSxcblxuICAgIG5ld1NpbmdsZVByb2plY3QocmVxLCByZXMpIHtcbiAgICAgICAgY29uc3QgbmV3UHJvamVjdCA9IG5ldyBQcm9qZWN0KHJlcS5ib2R5KTtcbiAgICAgICAgbmV3UHJvamVjdC5mcmllbmRseUlkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtsZW5ndGg6IDUsIHJlYWRhYmxlOiB0cnVlfSk7XG4gICAgICAgIG5ld1Byb2plY3Quc2F2ZSgpXG4gICAgICAgIC50aGVuKChwcm9qZWN0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcmVzLmpzb24ocHJvamVjdCk7XG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBuZXdUcmlnZ2VyZWRQcm9qZWN0KHJlcSwgcmVzKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzEgLSBOZXcgUHJvamVjdCBGdW5jdGlvbiBDYWxsZWRcIik7XG4gICAgICAgIHZhciB0ZW1wbGF0ZUlkID0gcmVxLnBhcmFtcy50ZW1wbGF0ZWlkO1xuICAgICAgICB2YXIgaW5zdGFuY2UgPSByZXEuYm9keS5pbnN0YW5jZTtcbiAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gcmVxLmJvZHkuZGVzY3JpcHRpb247XG4gICAgICAgIHZhciBhc3NvY2lhdGVkUHJvamVjdElkO1xuICAgICAgICB2YXIgbmV3UHJvamVjdDtcbiAgICAgICAgaGVscGVycy5tYWtlUHJvamVjdE9iamVjdCh0ZW1wbGF0ZUlkKVxuICAgICAgICAgIC50aGVuKChjbGVhbk9iamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMyAtIE1ha2UgUHJvamVjdCBPYmplY3QgUmV0dXJuZWQ6IFwiLCBjbGVhbk9iamVjdCk7XG4gICAgICAgICAgICBuZXdQcm9qZWN0ID0gbmV3IFByb2plY3QoY2xlYW5PYmplY3QpO1xuICAgICAgICAgICAgbmV3UHJvamVjdC5mcmllbmRseUlkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtsZW5ndGg6IDUsIHJlYWRhYmxlOiB0cnVlfSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIiM0IC0gTmV3IFByb2plY3QgSWQgOiBcIiwgbmV3UHJvamVjdC5faWQpO1xuICAgICAgICAgICAgYXNzb2NpYXRlZFByb2plY3RJZCA9IG5ld1Byb2plY3QuX2lkO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjNSAtIGFzc29jaWF0ZWRQcm9qZWN0SWQgOlwiLCBhc3NvY2lhdGVkUHJvamVjdElkKTtcbiAgICAgICAgICAgIHJldHVybiB0aW1lQ3RybC50cmlnZ2VyZWRQcm9qZWN0RGVhZGxpbmUoKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKChkZWFkbGluZSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMTQgLSBOZXh0IE9jY3VyYW5jZSBSZXR1cm5lZDogXCIsIGRlYWRsaW5lKTtcbiAgICAgICAgICAgIG5ld1Byb2plY3Quc2V0dXAuZHVlRGF0ZS5hY3R1YWwgPSBkZWFkbGluZTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzE1IC0gTmV3IFByb2plY3QgRGVhZGxpbmUgU2V0IDogXCIsIG5ld1Byb2plY3Quc2V0dXAuZHVlRGF0ZS5hY3R1YWwpO1xuICAgICAgICAgICAgcmV0dXJuIGhlbHBlcnMuZ2V0VGFza0FycmF5KHRlbXBsYXRlSWQpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oKGFycmF5b2ZJZHMpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzE3IC0gUmV0dXJuZWQgRnJvbSBUYXNrIEFycmF5IEhlbHBlciBcIiwgYXJyYXlvZklkcyk7XG4gICAgICAgICAgICAvL2ZvciBldmVyeSBpZCwgbWFrZSBhIG5ldyBwcm9qZWN0IHRhc2tcbiAgICAgICAgICAgIHZhciBuZXdfdGFza3NfcHJvbWlzZXMgPSBfLm1hcChhcnJheW9mSWRzLCBmdW5jdGlvbihpZCkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFycmF5IG9mIElkcyBJRCBcIiwgaWQpO1xuICAgICAgICAgICAgICByZXR1cm4gaGVscGVycy5tYWtlVGVtcGxhdGVUYXNrT2JqZWN0KGlkLCBhc3NvY2lhdGVkUHJvamVjdElkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy9uZXdfdGFza3NfcHJvbWlzZXMgbm93IGNvbnRhaW5zIGFuIGFycmF5IG9mIHByb21pc2VzIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgYXMgZWFjaCBvZiB0aGUgdGFza3MgYXJlIGNyZWF0ZWRcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzE5IC0gQXJyYXkgb2YgTmV3IFRhc2sgUHJvbWlzZXNcIiwgbmV3X3Rhc2tzX3Byb21pc2VzKTtcbiAgICAgICAgICAgIHJldHVybiBRLmFsbChuZXdfdGFza3NfcHJvbWlzZXMpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oKGNsZWFuX29iamVjdHMpID0+e1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMjAgLSBBcnJheSBvZiBOZXcgVGFzayBPYmplY3RzXCIsIGNsZWFuX29iamVjdHMpO1xuICAgICAgICAgICAgcmV0dXJuIFEuYWxsKF8ubWFwKGNsZWFuX29iamVjdHMsIChjbGVhbl9vYmplY3QpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIGhlbHBlcnMubWFrZVByb2plY3RUYXNrKGNsZWFuX29iamVjdCwgYXNzb2NpYXRlZFByb2plY3RJZCk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbigocHJvamVjdF90YXNrcykgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMjIgLSBQcm9qZWN0IFRhc2tzXCIsIHByb2plY3RfdGFza3MpO1xuICAgICAgICAgICAgLy90YWtlIHRhc2tzLCBwdXQgaW4gUHJvamVjdCwgc2F2ZVxuICAgICAgICAgICAgbmV3UHJvamVjdC5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9qZWN0X3Rhc2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIG5ld1Byb2plY3QudGFza3MucHVzaChwcm9qZWN0X3Rhc2tzW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ld1Byb2plY3Quc2F2ZSgpLnRoZW4oKHByb2plY3QpID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJNYWRlIGl0IVwiKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHByb2plY3QpO1xuICAgICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9LFxuXG4gIG9uZVByb2plY3QocmVxLCByZXMpIHtcbiAgICB2YXIgdGVtcGxhdGVPcHRpb25zID0ge1xuICAgICAgcGF0aDogJ3Rhc2tzJyxcbiAgICAgIG1vZGVsOiAnUHJvamVjdFRhc2snLFxuICAgICAgcG9wdWxhdGU6IHtcbiAgICAgICAgcGF0aDpcImFzc2lnbm1lbnQuZW1wbG95ZWVzXCIsXG4gICAgICAgIG1vZGVsOiBcIkVtcGxveWVlXCIsXG4gICAgICAgIHNlbGVjdDogXCJpZGVudGlmaWNhdGlvbi5uYW1lLmZ1bGxOYW1lXCJcbiAgICAgfVxuICAgIH1cbiAgICBQcm9qZWN0LmZpbmRCeUlkKHJlcS5wYXJhbXMuaWQpLnBvcHVsYXRlKHRlbXBsYXRlT3B0aW9ucykuZXhlYygpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgcmV0dXJuIHJlcy5qc29uKHJlc3VsdCk7XG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSxcblxuICBlZGl0UHJvamVjdChyZXEsIHJlcykge1xuICAgIFByb2plY3QudXBkYXRlKHtfaWQ6IHJlcS5wYXJhbXMuaWR9LCByZXEuYm9keSkudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmVuZCgpO1xuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0sXG5cbiAgZGVsZXRlUHJvamVjdChyZXEsIHJlcykge1xuICAgIFByb2plY3QucmVtb3ZlKHtfaWQ6IHJlcS5wYXJhbXMuaWR9LCByZXEuYm9keSkudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmVuZCgpO1xuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0sXG5cblxuICBhbGxQcm9qZWN0cyhyZXEsIHJlcykge1xuICAgIFByb2plY3QuZmluZCgpLnBvcHVsYXRlKCd0YXNrcycpLmV4ZWMoKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgIHJldHVybiByZXMuanNvbihyZXN1bHQpO1xuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH1cblxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
