'use strict';

var mongoose = require('mongoose');
var Employee = require('../models/Employee.js');
var Template = require('../models/Template.js');
var TemplateTask = require('../models/TemplateTask.js');
var ProjectTask = require('../models/ProjectTask.js');
var Q = require('q');
var timeCtrl = require('../controllers/timeCtrl.js');
var randomstring = require('randomstring');

module.exports = {
  getTaskArray: function getTaskArray(id) {
    console.log("#16 - Made it the Task Array");
    var deferred = Q.defer();
    Template.findById(id).exec().then(function (template) {
      var taskArray = template.tasks;
      deferred.resolve(taskArray);
    });
    return deferred.promise;
  },
  makeTemplateTaskObject: function makeTemplateTaskObject(id, associatedProjectId) {
    console.log("#18 - Made it to Template Task Object");
    var deferred = Q.defer();
    TemplateTask.findById(id).exec().then(function (returnedTask) {
      var task_plain = returnedTask.toObject();
      delete task_plain._id;
      delete task_plain.__v;
      delete task_plain.date.created;
      deferred.resolve(task_plain);
    });
    return deferred.promise;
  },
  makeProjectObject: function makeProjectObject(id) {
    console.log("#2 - Make Project Object Called");
    var deferred = Q.defer();
    Template.findById(id).exec().then(function (template) {
      var new_Object = template.toObject();
      delete new_Object._id;
      delete new_Object.__v;
      delete new_Object.tasks;
      deferred.resolve(new_Object);
    });
    return deferred.promise;
  },
  makeProjectTask: function makeProjectTask(object, associatedProjectId) {
    console.log("#21 Made it to Make Project Task", object, "ASSOCIATEDPROJECTID", associatedProjectId);
    var deferred = Q.defer();
    var newTask = new ProjectTask(object);
    newTask.friendlyId = randomstring.generate({ length: 5, readable: true });
    newTask.associatedProject = associatedProjectId;
    console.log("NEW TASK CREATED", newTask);
    newTask.save().then(function (task) {
      console.log("DID WE MAKE IT?", task);
      deferred.resolve(task._id);
    }).catch(function (err) {
      console.log("ERROR", err);
    });
    return deferred.promise;
  },
  nextOccurrence: function nextOccurrence(template, instance) {
    console.log("#6 - Next Occurance Called");
    console.log("#7 - Interval Type ", template.setup.interval.type);
    var deferred = Q.defer();
    var deadline;
    var intervalType = template.setup.interval.type;
    var path = "template.setup.interval";
    console.log("#8 - Path", path);

    if (intervalType === 'Weekly') {
      if (template.setup.interval.weeklyInterval !== 'Any') {
        deadline = timeCtrl.weeklySpecificDay(template.setup.interval.weeklyInterval, instance);
      } else {
        deadline = timeCtrl.weeklyAnyDay(instance);
      }
    } else if (intervalType === 'Bi-Weekly') {
      if (template.setup.interval.weeklyInterval !== 'Any') {
        deadline = timeCtrl.biWeeklySpecificDay(template.setup.interval.biWeeklyInterval, instance);
      } else {
        deadline = timeCtrl.biWeeklyAnyDay(instance);
      }
    } else if (intervalType === 'Monthly') {
      if (template.setup.interval.monthlyInterval.selection === "First Day of Month") {
        deadline = timeCtrl.monthlyFirstDay();
      } else if (template.setup.interval.monthlyInterval.selection === "Last Day of Month") {
        deadline = timeCtrl.monthlyLastDay(instance);
      } else if (template.setup.interval.monthlyInterval.selection === '# of Days From Start') {
        deadline = timeCtrl.monthlyDaysFromStart(template.setup.interval.monthlyInterval.fromBeginning, instance);
      } else if (template.setup.interval.monthlyInterval.selection === '# of Days Before End') {
        deadline = timeCtrl.monthlyDaysBeforeEnd(template.setup.interval.monthlyInterval.fromEnd, instance);
      } else {
        deadline = timeCtrl.monthlyAnyDay(instance);
      }
    } else if (intervalType === 'Semi-Monthly') {
      deadline = timeCtrl.semiMonthlyFirstCycle(template.setup.interval.semiMonthlyInterval.fromBeginning);
      template.setup.dueDate.anticipated = timeCtrl.semiMonthlySecondCycle(template.setup.interval.semiMonthlyInterval.fromEnd);
    } else if (intervalType === 'Quarterly') {
      if (template.setup.interval.quarterlyInterval.selection === 'First Day of the Quarter') {
        deadline = timeCtrl.quarterlyFirstDay();
      } else if (template.setup.interval.quarterlyInterval.selection === 'Last Day of the Quarter') {
        deadline = timeCtrl.quarterlyLastDay(instance);
      } else if (template.setup.interval.quarterlyInterval.selection === '# Days from Start') {
        deadline = timeCtrl.quarterlyDaysFromStart(template.setup.interval.quarterlyInterval.fromBeginning, instance);
      } else if (template.setup.interval.quarterlyInterval.selection === '# Days from End') {
        deadline = timeCtrl.quarterlyDaysBeforeEnd(template.setup.interval.quarterlyInterval.fromEnd, instance);
      } else {
        deadline = timeCtrl.quarterlyAnyDay(instance);
      }
    } else if (intervalType === 'Annually') {
      console.log("#10 - Made it to the correct type");
      if (template.setup.interval.annualInterval === 'First Day of the Year') {
        deadline = timeCtrl.annuallyFirstDay(instance);
      } else if (template.setup.interval.annualInterval.selection === 'Last Day of the Year') {
        deadline = timeCtrl.annuallyLastDay(instance);
      } else if (template.setup.interval.annualInterval.selection === 'In a Particular Month') {
        console.log("#11 - Make it to the correct annual selection!");
        console.log('template', template.setup.interval.annualInterval.selectMonth);
        deadline = timeCtrl.annuallyParticularMonth(template.setup.interval.annualInterval.selectMonth, instance);
        console.log("#13 - Deadline", deadline);
      } else if (template.setup.interval.annualInterval.selection === 'In a Particular Quarter') {
        deadline = timeCtrl.annuallyParticularQuarter(template.setup.interval.annualInterval.selectQuarter, instance);
      } else if (template.setup.interval.annualInterval.selection === '# of Days From Start') {
        deadline = timeCtrl.annuallyDaysFromStart(template.setup.interval.annualInterval.fromBeginning, instance);
      } else if (template.setup.interval.annualInterval.selection === '# of Days Before End') {
        deadline = timeCtrl.annuallyDaysBeforeEnd(template.setup.interval.annualInterval.fromEnd, instance);
      } else {
        deadline = timeCtrl.annuallyAnyDay(instance);
      }
    } else if (intervalType === 'Daily') {
      deadline = timeCtrl.nextDay();
    } else if (intervalType === 'Daily Business Day') {
      deadline = timeCtrl.nextBusinessDay();
    }
    deferred.resolve(deadline);
    return deferred.promise;
  },
  triggeredProject: function triggeredProject(date) {
    var deadline = '';
    if (template.setup.dueDate.target === 'Today') {
      date = timeCtrl.deadlineToday();
    } else if (template.setup.dueDate.target === 'Specific Date') {
      date = timeCtrl.dateDeadline(date);
    }
    deadline = template.setup.dueDate.actual;
    return deadline;
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlcl9hc3NldHMvY29udHJvbGxlcnMvcHJvamVjdEhlbHBlcnMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDckMsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbEQsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDbEQsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDMUQsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDeEQsSUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3ZELElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQzs7QUFFN0MsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUVmLGNBQVksd0JBQUMsRUFBRSxFQUFFO0FBQ2YsV0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0FBQzVDLFFBQUksUUFBUSxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUN2QixZQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUNsQixJQUFJLEVBQUUsQ0FDTixJQUFJLENBQUMsVUFBQyxRQUFRLEVBQUs7QUFDbEIsVUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQztBQUNqQyxjQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQzdCLENBQUMsQ0FBQztBQUNMLFdBQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQztHQUN6QjtBQUVELHdCQUFzQixrQ0FBQyxFQUFFLEVBQUUsbUJBQW1CLEVBQUU7QUFDOUMsV0FBTyxDQUFDLEdBQUcsQ0FBQyx1Q0FB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LENBQUMsQ0FBQztPQUM5QztLQUNGLE1BQU0sSUFBSSxZQUFZLEtBQUssT0FBTyxFQUFFO0FBQ2pDLGNBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDakMsTUFBTSxJQUFJLFlBQVksS0FBSyxvQkFBb0IsRUFBRTtBQUM5QyxjQUFRLEdBQUcsUUFBUSxDQUFDLGVBQWUsRUFBRSxDQUFDO0tBQ3pDO0FBQ0QsWUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMzQixXQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUM7R0FDekI7QUFFRCxrQkFBZ0IsNEJBQUMsSUFBSSxFQUFFO0FBQ3JCLFFBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNsQixRQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxPQUFPLEVBQUU7QUFDN0MsVUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLEVBQUUsQ0FBQztLQUNqQyxNQUFNLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLGVBQWUsRUFBRTtBQUM1RCxVQUFJLEdBQUcsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNwQztBQUNELFlBQVEsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDekMsV0FBTyxRQUFRLENBQUM7R0FDakI7Q0FFSixDQUFDIiwiZmlsZSI6InNlcnZlcl9hc3NldHMvY29udHJvbGxlcnMvcHJvamVjdEhlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XG5jb25zdCBFbXBsb3llZSA9IHJlcXVpcmUoJy4uL21vZGVscy9FbXBsb3llZS5qcycpO1xuY29uc3QgVGVtcGxhdGUgPSByZXF1aXJlKCcuLi9tb2RlbHMvVGVtcGxhdGUuanMnKTtcbmNvbnN0IFRlbXBsYXRlVGFzayA9IHJlcXVpcmUoJy4uL21vZGVscy9UZW1wbGF0ZVRhc2suanMnKTtcbmNvbnN0IFByb2plY3RUYXNrID0gcmVxdWlyZSgnLi4vbW9kZWxzL1Byb2plY3RUYXNrLmpzJyk7XG5jb25zdCBRID0gcmVxdWlyZSgncScpO1xuY29uc3QgdGltZUN0cmwgPSByZXF1aXJlKCcuLi9jb250cm9sbGVycy90aW1lQ3RybC5qcycpO1xuY29uc3QgcmFuZG9tc3RyaW5nID0gcmVxdWlyZSgncmFuZG9tc3RyaW5nJyk7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gIGdldFRhc2tBcnJheShpZCkge1xuICAgIGNvbnNvbGUubG9nKFwiIzE2IC0gTWFkZSBpdCB0aGUgVGFzayBBcnJheVwiKTtcbiAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XG4gICAgICBUZW1wbGF0ZS5maW5kQnlJZChpZClcbiAgICAgICAgLmV4ZWMoKVxuICAgICAgICAudGhlbigodGVtcGxhdGUpID0+IHtcbiAgICAgICAgICBjb25zdCB0YXNrQXJyYXkgPSB0ZW1wbGF0ZS50YXNrcztcbiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHRhc2tBcnJheSk7XG4gICAgICAgIH0pO1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfSxcblxuICAgIG1ha2VUZW1wbGF0ZVRhc2tPYmplY3QoaWQsIGFzc29jaWF0ZWRQcm9qZWN0SWQpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiIzE4IC0gTWFkZSBpdCB0byBUZW1wbGF0ZSBUYXNrIE9iamVjdFwiKTtcbiAgICAgIHZhciBkZWZlcnJlZCA9IFEuZGVmZXIoKTtcbiAgICAgIFRlbXBsYXRlVGFzay5maW5kQnlJZChpZClcbiAgICAgICAgLmV4ZWMoKVxuICAgICAgICAudGhlbigocmV0dXJuZWRUYXNrKSA9PiB7XG4gICAgICAgICAgY29uc3QgdGFza19wbGFpbiA9IHJldHVybmVkVGFzay50b09iamVjdCgpO1xuICAgICAgICAgIGRlbGV0ZSB0YXNrX3BsYWluLl9pZDtcbiAgICAgICAgICBkZWxldGUgdGFza19wbGFpbi5fX3Y7XG4gICAgICAgICAgZGVsZXRlIHRhc2tfcGxhaW4uZGF0ZS5jcmVhdGVkO1xuICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodGFza19wbGFpbik7XG4gICAgICAgIH0pO1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfSxcblxuICAgIG1ha2VQcm9qZWN0T2JqZWN0KGlkKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIiMyIC0gTWFrZSBQcm9qZWN0IE9iamVjdCBDYWxsZWRcIik7XG4gICAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XG4gICAgICBUZW1wbGF0ZS5maW5kQnlJZChpZClcbiAgICAgICAgLmV4ZWMoKVxuICAgICAgICAudGhlbigodGVtcGxhdGUpID0+IHtcbiAgICAgICAgICB2YXIgbmV3X09iamVjdCA9IHRlbXBsYXRlLnRvT2JqZWN0KCk7XG4gICAgICAgICAgZGVsZXRlIG5ld19PYmplY3QuX2lkO1xuICAgICAgICAgIGRlbGV0ZSBuZXdfT2JqZWN0Ll9fdjtcbiAgICAgICAgICBkZWxldGUgbmV3X09iamVjdC50YXNrcztcbiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKG5ld19PYmplY3QpO1xuICAgICAgICB9KTtcbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH0sXG5cbiAgICBtYWtlUHJvamVjdFRhc2sob2JqZWN0LCBhc3NvY2lhdGVkUHJvamVjdElkKXtcbiAgICAgIGNvbnNvbGUubG9nKFwiIzIxIE1hZGUgaXQgdG8gTWFrZSBQcm9qZWN0IFRhc2tcIiwgb2JqZWN0LCBcIkFTU09DSUFURURQUk9KRUNUSURcIiwgYXNzb2NpYXRlZFByb2plY3RJZCk7XG4gICAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XG4gICAgICB2YXIgbmV3VGFzayA9IG5ldyBQcm9qZWN0VGFzayhvYmplY3QpO1xuICAgICAgbmV3VGFzay5mcmllbmRseUlkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtsZW5ndGg6IDUsIHJlYWRhYmxlOiB0cnVlfSk7XG4gICAgICBuZXdUYXNrLmFzc29jaWF0ZWRQcm9qZWN0ID0gYXNzb2NpYXRlZFByb2plY3RJZDtcbiAgICAgIGNvbnNvbGUubG9nKFwiTkVXIFRBU0sgQ1JFQVRFRFwiLCBuZXdUYXNrKTtcbiAgICAgIG5ld1Rhc2suc2F2ZSgpXG4gICAgICAgIC50aGVuKCh0YXNrKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRJRCBXRSBNQUtFIElUP1wiLCB0YXNrKTtcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodGFzay5faWQpO1xuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkVSUk9SXCIsIGVycik7XG4gICAgICAgIH0pO1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfSxcblxuICAgIG5leHRPY2N1cnJlbmNlKHRlbXBsYXRlLCBpbnN0YW5jZSkge1xuICAgICAgY29uc29sZS5sb2coXCIjNiAtIE5leHQgT2NjdXJhbmNlIENhbGxlZFwiKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiIzcgLSBJbnRlcnZhbCBUeXBlIFwiLCB0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC50eXBlKTtcbiAgICAgIHZhciBkZWZlcnJlZCA9IFEuZGVmZXIoKTtcbiAgICAgIHZhciBkZWFkbGluZTtcbiAgICAgIHZhciBpbnRlcnZhbFR5cGUgPSB0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC50eXBlO1xuICAgICAgdmFyIHBhdGggPSBcInRlbXBsYXRlLnNldHVwLmludGVydmFsXCI7XG4gICAgICBjb25zb2xlLmxvZyhcIiM4IC0gUGF0aFwiLCBwYXRoKTtcblxuICAgICAgaWYgKGludGVydmFsVHlwZSA9PT0gJ1dlZWtseScpIHtcbiAgICAgICAgaWYgKHRlbXBsYXRlLnNldHVwLmludGVydmFsLndlZWtseUludGVydmFsICE9PSAnQW55Jykge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwud2Vla2x5U3BlY2lmaWNEYXkodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwud2Vla2x5SW50ZXJ2YWwsIGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLndlZWtseUFueURheShpbnN0YW5jZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoaW50ZXJ2YWxUeXBlID09PSAnQmktV2Vla2x5Jykge1xuICAgICAgICBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwud2Vla2x5SW50ZXJ2YWwgIT09ICdBbnknKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5iaVdlZWtseVNwZWNpZmljRGF5KHRlbXBsYXRlLnNldHVwLmludGVydmFsLmJpV2Vla2x5SW50ZXJ2YWwsIGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLmJpV2Vla2x5QW55RGF5KGluc3RhbmNlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChpbnRlcnZhbFR5cGUgPT09ICdNb250aGx5Jykge1xuICAgICAgICBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwubW9udGhseUludGVydmFsLnNlbGVjdGlvbiA9PT0gXCJGaXJzdCBEYXkgb2YgTW9udGhcIikge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwubW9udGhseUZpcnN0RGF5KCk7XG4gICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwubW9udGhseUludGVydmFsLnNlbGVjdGlvbiA9PT0gXCJMYXN0IERheSBvZiBNb250aFwiKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5tb250aGx5TGFzdERheShpbnN0YW5jZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwubW9udGhseUludGVydmFsLnNlbGVjdGlvbiA9PT0gJyMgb2YgRGF5cyBGcm9tIFN0YXJ0Jykge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwubW9udGhseURheXNGcm9tU3RhcnQodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwubW9udGhseUludGVydmFsLmZyb21CZWdpbm5pbmcsIGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5tb250aGx5SW50ZXJ2YWwuc2VsZWN0aW9uID09PSAnIyBvZiBEYXlzIEJlZm9yZSBFbmQnKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5tb250aGx5RGF5c0JlZm9yZUVuZCh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5tb250aGx5SW50ZXJ2YWwuZnJvbUVuZCwgaW5zdGFuY2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwubW9udGhseUFueURheShpbnN0YW5jZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoaW50ZXJ2YWxUeXBlID09PSAnU2VtaS1Nb250aGx5Jykge1xuICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLnNlbWlNb250aGx5Rmlyc3RDeWNsZSh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5zZW1pTW9udGhseUludGVydmFsLmZyb21CZWdpbm5pbmcpO1xuICAgICAgICB0ZW1wbGF0ZS5zZXR1cC5kdWVEYXRlLmFudGljaXBhdGVkID0gdGltZUN0cmwuc2VtaU1vbnRobHlTZWNvbmRDeWNsZSh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5zZW1pTW9udGhseUludGVydmFsLmZyb21FbmQpO1xuICAgICAgfSBlbHNlIGlmIChpbnRlcnZhbFR5cGUgPT09ICdRdWFydGVybHknKSB7XG4gICAgICAgIGlmICh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5xdWFydGVybHlJbnRlcnZhbC5zZWxlY3Rpb24gPT09ICdGaXJzdCBEYXkgb2YgdGhlIFF1YXJ0ZXInKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5xdWFydGVybHlGaXJzdERheSgpO1xuICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlLnNldHVwLmludGVydmFsLnF1YXJ0ZXJseUludGVydmFsLnNlbGVjdGlvbiA9PT0gJ0xhc3QgRGF5IG9mIHRoZSBRdWFydGVyJykge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwucXVhcnRlcmx5TGFzdERheShpbnN0YW5jZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwucXVhcnRlcmx5SW50ZXJ2YWwuc2VsZWN0aW9uID09PSAnIyBEYXlzIGZyb20gU3RhcnQnKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5xdWFydGVybHlEYXlzRnJvbVN0YXJ0KHRlbXBsYXRlLnNldHVwLmludGVydmFsLnF1YXJ0ZXJseUludGVydmFsLmZyb21CZWdpbm5pbmcsIGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5xdWFydGVybHlJbnRlcnZhbC5zZWxlY3Rpb24gPT09ICcjIERheXMgZnJvbSBFbmQnKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5xdWFydGVybHlEYXlzQmVmb3JlRW5kKHRlbXBsYXRlLnNldHVwLmludGVydmFsLnF1YXJ0ZXJseUludGVydmFsLmZyb21FbmQsIGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLnF1YXJ0ZXJseUFueURheShpbnN0YW5jZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoaW50ZXJ2YWxUeXBlID09PSAnQW5udWFsbHknKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzEwIC0gTWFkZSBpdCB0byB0aGUgY29ycmVjdCB0eXBlXCIpO1xuICAgICAgICBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwuYW5udWFsSW50ZXJ2YWwgPT09ICdGaXJzdCBEYXkgb2YgdGhlIFllYXInKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5hbm51YWxseUZpcnN0RGF5KGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5hbm51YWxJbnRlcnZhbC5zZWxlY3Rpb24gPT09ICdMYXN0IERheSBvZiB0aGUgWWVhcicpIHtcbiAgICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLmFubnVhbGx5TGFzdERheShpbnN0YW5jZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwuYW5udWFsSW50ZXJ2YWwuc2VsZWN0aW9uID09PSAnSW4gYSBQYXJ0aWN1bGFyIE1vbnRoJykge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzExIC0gTWFrZSBpdCB0byB0aGUgY29ycmVjdCBhbm51YWwgc2VsZWN0aW9uIVwiKTtcbiAgICAgICAgICBjb25zb2xlLmxvZygndGVtcGxhdGUnLCB0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5hbm51YWxJbnRlcnZhbC5zZWxlY3RNb250aCk7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5hbm51YWxseVBhcnRpY3VsYXJNb250aCh0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5hbm51YWxJbnRlcnZhbC5zZWxlY3RNb250aCwgaW5zdGFuY2UpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzEzIC0gRGVhZGxpbmVcIiwgZGVhZGxpbmUpO1xuICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlLnNldHVwLmludGVydmFsLmFubnVhbEludGVydmFsLnNlbGVjdGlvbiA9PT0gJ0luIGEgUGFydGljdWxhciBRdWFydGVyJykge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwuYW5udWFsbHlQYXJ0aWN1bGFyUXVhcnRlcih0ZW1wbGF0ZS5zZXR1cC5pbnRlcnZhbC5hbm51YWxJbnRlcnZhbC5zZWxlY3RRdWFydGVyLCBpbnN0YW5jZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwuYW5udWFsSW50ZXJ2YWwuc2VsZWN0aW9uID09PSAnIyBvZiBEYXlzIEZyb20gU3RhcnQnKSB7XG4gICAgICAgICAgZGVhZGxpbmUgPSB0aW1lQ3RybC5hbm51YWxseURheXNGcm9tU3RhcnQodGVtcGxhdGUuc2V0dXAuaW50ZXJ2YWwuYW5udWFsSW50ZXJ2YWwuZnJvbUJlZ2lubmluZywgaW5zdGFuY2UpO1xuICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlLnNldHVwLmludGVydmFsLmFubnVhbEludGVydmFsLnNlbGVjdGlvbiA9PT0gJyMgb2YgRGF5cyBCZWZvcmUgRW5kJykge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwuYW5udWFsbHlEYXlzQmVmb3JlRW5kKHRlbXBsYXRlLnNldHVwLmludGVydmFsLmFubnVhbEludGVydmFsLmZyb21FbmQsIGluc3RhbmNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLmFubnVhbGx5QW55RGF5KGluc3RhbmNlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChpbnRlcnZhbFR5cGUgPT09ICdEYWlseScpIHtcbiAgICAgICAgICBkZWFkbGluZSA9IHRpbWVDdHJsLm5leHREYXkoKTtcbiAgICAgIH0gZWxzZSBpZiAoaW50ZXJ2YWxUeXBlID09PSAnRGFpbHkgQnVzaW5lc3MgRGF5Jykge1xuICAgICAgICAgIGRlYWRsaW5lID0gdGltZUN0cmwubmV4dEJ1c2luZXNzRGF5KCk7XG4gICAgICB9XG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKGRlYWRsaW5lKTtcbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH0sXG5cbiAgICB0cmlnZ2VyZWRQcm9qZWN0KGRhdGUpIHtcbiAgICAgIGxldCBkZWFkbGluZSA9ICcnO1xuICAgICAgaWYgKHRlbXBsYXRlLnNldHVwLmR1ZURhdGUudGFyZ2V0ID09PSAnVG9kYXknKSB7XG4gICAgICAgIGRhdGUgPSB0aW1lQ3RybC5kZWFkbGluZVRvZGF5KCk7XG4gICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlLnNldHVwLmR1ZURhdGUudGFyZ2V0ID09PSAnU3BlY2lmaWMgRGF0ZScpIHtcbiAgICAgICAgZGF0ZSA9IHRpbWVDdHJsLmRhdGVEZWFkbGluZShkYXRlKTtcbiAgICAgIH1cbiAgICAgIGRlYWRsaW5lID0gdGVtcGxhdGUuc2V0dXAuZHVlRGF0ZS5hY3R1YWw7XG4gICAgICByZXR1cm4gZGVhZGxpbmU7XG4gICAgfSxcblxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
